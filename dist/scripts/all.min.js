function authorize(e,t,r,n,a){var i=q.defer(),a=new googleAuth,o=new a.OAuth2(t,e,n),s=cache.get(CACHE_TOKEN_KEY);return console.log("cached creds: "+s),s?(o.credentials=s,i.resolve(o)):getNewToken(o,r).then(function(e){var t=new Date(e.expiry_date).toISOString(),r=(new Date).toISOString(),n=new Date(t).getTime()-new Date(r).getTime(),a=n/1e3;cache.set(CACHE_TOKEN_KEY,e,a-60),o.credentials=e,i.resolve(o)}),i.promise}function getNewToken(e,t){var r=q.defer();return e.setCredentials({refresh_token:t}),console.log("getting new token"),e.refreshAccessToken(function(e,t){e?r.reject(e):r.resolve(t)}),r.promise}function insertEvent(e,t,r,n,a,i,o){var s=q.defer(),l=google.calendar("v3");return l.events.insert({auth:e,calendarId:"primary",resource:{summary:"Запазен час за урок по математика",description:"Урок по математика за  "+n+" клас. При въпроси или проблеми, можете да ме потърсите на тел: "+i,location:a,start:{dateTime:t},end:{dateTime:r},attendees:[{email:o},{email:"urocimatematikaneli@gmail.com"}],reminders:{useDefault:!1,overrides:[{method:"email",minutes:180},{method:"popup",minutes:30}]}}},function(e,t){e&&s.reject(e),s.resolve(t)}),s.promise}function getAvailableTimeArr(e,t){var r=q.defer(),n=google.calendar("v3"),a=new Date(t),i=a.getDate()-a.getDay()+1,o=i+6,s=new Date(a.setDate(i)).toISOString(),l=new Date(new Date(a.setDate(o)).setHours(23,59,0)).toISOString();return n.events.list({auth:e,calendarId:"primary",singleEvents:!0,orderBy:"startTime",timeMin:s,timeMax:l},function(e,t){e&&r.reject("The API returned an error: "+e);var n=t.items;if(0==n.length)r.reject("No upcoming events found.");else{var a=getAvailableHours(n,s,l);r.resolve(a)}}),r.promise}function hoursCompare(e,t){var r=new Date,n=e.split(":");r.setHours(n[0],n[1],n[2],0);var a=new Date;return n=t.split(":"),a.setHours(n[0],n[1],n[2],0),r.getTime()>a.getTime()?1:r.getTime()<a.getTime()?-1:0}function getDates(e,t){for(var r=new Array,n=e;n<=t;)r.push(n),n=n.addMinutes(30);return r}function getFreeTime(e,t,r,n,a){var i=[],o=8,s=20,l=new Date(new Date(t).setHours(o,0,0)),u=new Date(new Date(t).setHours(s,0,0)),d=[];e.map(function(e){new Date(e.start.dateTime).getDay()==l.getDay()&&d.push(e)});for(var c=l;c<=u;c.setMinutes(c.getMinutes()+30))i.push(new Date(c));return i=i.filter(function(e){var t=d.every(function(t){var r=new Date(t.start.dateTime),n=new Date(t.end.dateTime);n.setMinutes(r.getMinutes()+30);var a=new Date(t.start.dateTime);a.setMinutes(r.getMinutes()-90);var i=e>a&&e<n;return!i});return 0==d.length||t})}function getAvailableHours(e,t,r){for(var n=8,a=21,i=new Date(new Date(t).setHours(n,0,0)),o=new Date(new Date(r).setHours(a,0,0)),s=[],l=i.toTimeString().split(" ")[0],u=o.toTimeString().split(" ")[0],d=30,c=i;c<=o;c=c.addDays(1)){var g=getFreeTime(e,c,l,u,d);s=s.concat(g)}return s}$(function(){var e="mathLessonBookingDetails";if("undefined"!=typeof localStorage){var t=localStorage.getItem(e);if(t){var r=JSON.parse(t);$("#name").val(r.name),$("#phone").val(r.phone),$("#lessonClass").val(r.lessonClass),$('input[value="'+r.address+'"]').prop("checked",!0)}}$("#booking-form").submit(function(){if($(this).valid()&&"undefined"!=typeof localStorage){var t=$("#name").val(),r=$("#phone").val(),n=$("#lessonClass").val(),a=$('input[name="address"]:checked').val(),i={name:t,phone:r,lessonClass:n,address:a},o=JSON.stringify(i);localStorage.setItem(e,o)}})}),$(function(){$("#booking-form").validate({rules:{name:{required:!0,minlength:2,lettersOnly:!0},phone:{required:!0,minlength:10},hour:{required:!0},email:{required:!0,validEmail:!0},agree:"required",ownAddress:"required"},messages:{name:{required:"Името е задължително",minlength:"Името трябва да съдържа поне 2 букви",lettersOnly:"Името може да съдържа само букви"},phone:{required:"Телефонът в задължителен",minlength:"Телефонът трябва да съдържа минимум 10 цифри"},hour:{required:"Моля изберете час"},email:{required:"E-mail адресът е задължителен",validEmail:"E-mail адресът трябва да бъде валиден"},agree:"Трябва да декларирате че сте наясно, че запазвате истински урок",ownAddress:"Адресът е задължителен"},errorPlacement:function(e,t){e.insertBefore(t.parent())},ignore:":not(:visible)"}),jQuery.validator.addMethod("validEmail",function(e,t){return/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(e)}),jQuery.validator.addMethod("lettersOnly",function(e,t){return this.optional(t)||/^[A-z А-з ]+$/i.test(e)})}),$(function(){function e(e){for(var t=e+"=",r=document.cookie.split(";"),n=0;n<r.length;n++){for(var a=r[n];" "==a.charAt(0);)a=a.substring(1);if(0==a.indexOf(t))return a.substring(t.length,a.length)}return null}var t="cookie-consent";e(t)||($("#cookie-consent-container").removeClass("hidden"),$("#cookie-consent-ok").click(function(){var e=new Date;e.setFullYear(e.getFullYear()+1),cookie_string=t+"=true; path=/; expires="+e.toUTCString(),document.cookie=cookie_string}))});var fs=require("fs"),readline=require("readline"),google=require("googleapis"),googleAuth=require("google-auth-library"),NodeCache=require("node-cache"),q=require("q"),cache=new NodeCache;const CACHE_TOKEN_KEY="calTok";module.exports={authorize:authorize,getAvailableTimeArr:getAvailableTimeArr,insertEvent:insertEvent},Date.prototype.addDays=function(e){var t=new Date(this.valueOf());return t.setDate(t.getDate()+e),t};